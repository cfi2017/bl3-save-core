package profile

import (
	"io"

	"github.com/cfi2017/bl3-save-core/pkg/pb"
	shared2 "github.com/cfi2017/bl3-save-core/pkg/shared"
	"google.golang.org/protobuf/proto"
)

var (
	platforms = map[string]shared2.PlatformMagic{
		"pc": {
			Prefix: []byte{
				0xD8, 0x04, 0xB9, 0x08, 0x5C, 0x4E, 0x2B, 0xC0,
				0x61, 0x9F, 0x7C, 0x8D, 0x5D, 0x34, 0x00, 0x56,
				0xE7, 0x7B, 0x4E, 0xC0, 0xA4, 0xD6, 0xA7, 0x01,
				0x14, 0x15, 0xA9, 0x93, 0x1F, 0x27, 0x2C, 0x8F,
			}, Xor: []byte{
				0xE8, 0xDC, 0x3A, 0x66, 0xF7, 0xEF, 0x85, 0xE0,
				0xBD, 0x4A, 0xA9, 0x73, 0x57, 0x99, 0x30, 0x8C,
				0x94, 0x63, 0x59, 0xA8, 0xC9, 0xAE, 0xD9, 0x58,
				0x7D, 0x51, 0xB0, 0x1E, 0xBE, 0xD0, 0x77, 0x43,
			},
		},
		"ps4": {
			Prefix: []byte{
				0xad, 0x1e, 0x60, 0x4e, 0x42, 0x9e, 0xa9, 0x33,
				0xb2, 0xf5, 0x01, 0xe1, 0x02, 0x4d, 0x08, 0x75,
				0xb1, 0xad, 0x1a, 0x3d, 0xa1, 0x03, 0x6b, 0x1a,
				0x17, 0xe6, 0xec, 0x0f, 0x60, 0x8d, 0xb4, 0xf9,
			}, Xor: []byte{
				0xba, 0x0e, 0x86, 0x1d, 0x58, 0xe1, 0x92, 0x21,
				0x30, 0xd6, 0xcb, 0xf0, 0xd0, 0x82, 0xd5, 0x58,
				0x36, 0x12, 0xe1, 0xf6, 0x39, 0x44, 0x88, 0xea,
				0x4e, 0xfb, 0x04, 0x74, 0x07, 0x95, 0x3a, 0xa2,
			},
		},
	}
)

func Decrypt(reader io.Reader, platform string) (shared2.SavFile, []byte) {
	s, data := shared2.DeserializeHeader(reader)
	return s, shared2.Decrypt(data, platforms[platform].Prefix, platforms[platform].Xor)
}

func Deserialize(reader io.Reader, platform string) (shared2.SavFile, pb.Profile) {
	// deserialise header, decrypt data
	s, data := Decrypt(reader, platform)

	p := pb.Profile{}
	if err := proto.Unmarshal(data, &p); err != nil {
		panic("couldn't unmarshal protobuf data")
	}

	return s, p
}

func Serialize(writer io.Writer, s shared2.SavFile, p pb.Profile, platform string) {
	bs, err := proto.Marshal(&p)
	if err != nil {
		panic(err)
	}
	bs = shared2.Encrypt(bs, platforms[platform].Prefix, platforms[platform].Xor)
	shared2.SerializeHeader(writer, s, bs)

}
